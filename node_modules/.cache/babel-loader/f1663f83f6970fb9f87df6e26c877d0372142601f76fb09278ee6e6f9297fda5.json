{"ast":null,"code":"import { fromUrl } from 'geotiff';\nimport proj4 from 'proj4';\n\n// Definimos las proyecciones para reprojectar coordenadas\nproj4.defs('EPSG:4326', '+proj=longlat +datum=WGS84 +no_defs');\nproj4.defs('EPSG:32614', '+proj=utm +zone=14 +datum=WGS84 +units=m +no_defs');\n\n/**\r\n * Muestra el valor de NDWI en la coordenada dada\r\n * usando las URLs de las bandas NIR (B5) y SWIR1 (B6).\r\n * @param {string} nirUrl  URL completa al COG de B5 (incluye SAS)\r\n * @param {string} swirUrl URL completa al COG de B6 (incluye SAS)\r\n * @param {number} lat     Latitud (EPSG:4326)\r\n * @param {number} lng     Longitud (EPSG:4326)\r\n * @returns {Promise<number>} NDWI = (nir - swir) / (nir + swir)\r\n */\nexport async function sampleNdwi(nirUrl, swirUrl, lat, lng) {\n  // 1) Abre ambos COGs\n  const [tiffNIR, tiffSWIR] = await Promise.all([fromUrl(nirUrl), fromUrl(swirUrl)]);\n  const [imgNIR, imgSWIR] = await Promise.all([tiffNIR.getImage(), tiffSWIR.getImage()]);\n\n  // 2) Reproyectar lat/lng (WGS84) a coordenadas de mapa (UTM14N)\n  const [xMap, yMap] = proj4('EPSG:4326', 'EPSG:32614', [lng, lat]);\n  console.log('Reprojected coordinates:', {\n    xMap,\n    yMap\n  });\n\n  // 3) Obtener georreferenciación del COG\n  const [originX, originY] = imgNIR.getOrigin(); // [x0, y0] en misma proyección\n  const [resX, resY] = imgNIR.getResolution(); // [pixelWidth, pixelHeight]\n  const width = imgNIR.getWidth();\n  const height = imgNIR.getHeight();\n\n  // 4) Calcular columna/fila usando coordenadas re-proyectadas\n  const col = Math.floor((xMap - originX) / resX);\n  const row = Math.floor((originY - yMap) / Math.abs(resY));\n  console.log('GeoTIFF info → origin:', originX, originY, 'resolution:', resX, resY, 'dims:', width, height);\n  console.log('Sampling pixel → col:', col, 'row:', row);\n\n  // 5) Verifica límites de la imagen\n  if (col < 0 || col >= width || row < 0 || row >= height) {\n    console.warn('Coordenada fuera de los límites de la imagen');\n    return null;\n  }\n\n  // 6) Lee un píxel de cada banda\n  const [nirVals] = await imgNIR.readRasters({\n    window: [col, row, col + 1, row + 1],\n    samples: [0]\n  });\n  const [swirVals] = await imgSWIR.readRasters({\n    window: [col, row, col + 1, row + 1],\n    samples: [0]\n  });\n  const nir = nirVals[0];\n  const swir = swirVals[0];\n  console.log('Raw pixel values → nir:', nir, 'swir:', swir);\n\n  // 7) Manejo de píxeles nodata\n  if (nir == null || swir == null || nir + swir === 0) {\n    console.warn('Valores inválidos o nodata para NDWI');\n    return null;\n  }\n\n  // 8) Calcula NDWI\n  const ndwi = (nir - swir) / (nir + swir);\n  console.log('Computed NDWI:', ndwi);\n  return ndwi;\n}","map":{"version":3,"names":["fromUrl","proj4","defs","sampleNdwi","nirUrl","swirUrl","lat","lng","tiffNIR","tiffSWIR","Promise","all","imgNIR","imgSWIR","getImage","xMap","yMap","console","log","originX","originY","getOrigin","resX","resY","getResolution","width","getWidth","height","getHeight","col","Math","floor","row","abs","warn","nirVals","readRasters","window","samples","swirVals","nir","swir","ndwi"],"sources":["C:/Users/ivan.djgonzalez/Desktop/fotoMapa/photo-gps-viewer/src/utils/ndwi-client.js"],"sourcesContent":["import { fromUrl } from 'geotiff'\r\nimport proj4 from 'proj4'\r\n\r\n// Definimos las proyecciones para reprojectar coordenadas\r\nproj4.defs('EPSG:4326', '+proj=longlat +datum=WGS84 +no_defs')\r\nproj4.defs('EPSG:32614', '+proj=utm +zone=14 +datum=WGS84 +units=m +no_defs')\r\n\r\n/**\r\n * Muestra el valor de NDWI en la coordenada dada\r\n * usando las URLs de las bandas NIR (B5) y SWIR1 (B6).\r\n * @param {string} nirUrl  URL completa al COG de B5 (incluye SAS)\r\n * @param {string} swirUrl URL completa al COG de B6 (incluye SAS)\r\n * @param {number} lat     Latitud (EPSG:4326)\r\n * @param {number} lng     Longitud (EPSG:4326)\r\n * @returns {Promise<number>} NDWI = (nir - swir) / (nir + swir)\r\n */\r\nexport async function sampleNdwi(nirUrl, swirUrl, lat, lng) {\r\n  // 1) Abre ambos COGs\r\n  const [tiffNIR, tiffSWIR] = await Promise.all([\r\n    fromUrl(nirUrl),\r\n    fromUrl(swirUrl)\r\n  ])\r\n  const [imgNIR, imgSWIR] = await Promise.all([\r\n    tiffNIR.getImage(),\r\n    tiffSWIR.getImage()\r\n  ])\r\n\r\n  // 2) Reproyectar lat/lng (WGS84) a coordenadas de mapa (UTM14N)\r\n  const [xMap, yMap] = proj4('EPSG:4326', 'EPSG:32614', [lng, lat])\r\n  console.log('Reprojected coordinates:', { xMap, yMap })\r\n\r\n  // 3) Obtener georreferenciación del COG\r\n  const [originX, originY] = imgNIR.getOrigin()      // [x0, y0] en misma proyección\r\n  const [resX, resY]       = imgNIR.getResolution()  // [pixelWidth, pixelHeight]\r\n  const width  = imgNIR.getWidth()\r\n  const height = imgNIR.getHeight()\r\n\r\n  // 4) Calcular columna/fila usando coordenadas re-proyectadas\r\n  const col = Math.floor((xMap - originX) / resX)\r\n  const row = Math.floor((originY - yMap)  / Math.abs(resY))\r\n\r\n  console.log('GeoTIFF info → origin:', originX, originY,\r\n              'resolution:', resX, resY,\r\n              'dims:', width, height)\r\n  console.log('Sampling pixel → col:', col, 'row:', row)\r\n\r\n  // 5) Verifica límites de la imagen\r\n  if (col < 0 || col >= width || row < 0 || row >= height) {\r\n    console.warn('Coordenada fuera de los límites de la imagen')\r\n    return null\r\n  }\r\n\r\n  // 6) Lee un píxel de cada banda\r\n  const [nirVals] = await imgNIR.readRasters({\r\n    window : [col, row, col + 1, row + 1],\r\n    samples: [0]\r\n  })\r\n  const [swirVals] = await imgSWIR.readRasters({\r\n    window : [col, row, col + 1, row + 1],\r\n    samples: [0]\r\n  })\r\n\r\n  const nir  = nirVals[0]\r\n  const swir = swirVals[0]\r\n  console.log('Raw pixel values → nir:', nir, 'swir:', swir)\r\n\r\n  // 7) Manejo de píxeles nodata\r\n  if (nir == null || swir == null || (nir + swir) === 0) {\r\n    console.warn('Valores inválidos o nodata para NDWI')\r\n    return null\r\n  }\r\n\r\n  // 8) Calcula NDWI\r\n  const ndwi = (nir - swir) / (nir + swir)\r\n  console.log('Computed NDWI:', ndwi)\r\n  return ndwi\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}